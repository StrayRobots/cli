#!/bin/bash
set -e

BIN_DIR="$HOME/.stray/env/bin/"
CONTAINER_PREFIX="strayrobots/"
ANALYTICS_URL="https://app.strayrobots.io/event"
VERSION="1.1.0"
PULL_IMAGES=true

if [ "$STRAY_DEV" != "" ]
    then
        CONTAINER_PREFIX=""
        BIN_DIR=""
        PULL_IMAGES=false
fi

absolute_path() {
    echo "$(cd "$(dirname "$1")"; pwd)/$(basename "$1")"
}

check_data_dir() {
    if [ ! -d "$1" ]; then
        echo "data directory does not exist: $1"
        exit 1
    fi
}

log_event() {
    if [ "$DO_NOT_TRACK" = "" ]; then
        (curl --request POST --url $ANALYTICS_URL --header 'Content-Type: application/json' --data "{ \"name\": \"cli:$1\", \"version\": \"$VERSION\" }" 2> /dev/null > /dev/null &)
    fi
}

label-subcommand() {
    if [ $# -lt 2 ]
        then
            echo "Not enough arguments supplied"
            exit 1
    fi

    if [ "$2" = "generate" ]
    then
        log_event "label-generate:start"
        ${BIN_DIR}stray-label-generate "${@:3}"
    elif [ "$2" = "show" ]
    then
        log_event "label-show:start"
        ${BIN_DIR}stray-label-show "${@:3}"
    else
        echo "Incorrect verb"
    fi
}

validate-model-bake-flags() {
    model_found=false
    i=0
    args=("$@")
    for arg in "$@"
    do
        if [ $arg = "--model" ]
        then
            if [ ! -d "${args[i+1]}" ]
            then
                echo "Model ${args[i+1]} does not exist"
                exit 1
            else
                model_found=true
            fi
        fi
        i=$((i + 1))
    done
    if [ ! model_found ]
    then
        echo "Missing the --model flag"
        exit 1
    fi
}

model-bake-command() {
    validate-model-bake-flags $@
    CMD="docker run "
    DOCKER_ARGS=""
    #Add scenes
    for arg in "$@"
    do
        if [ $arg = "--model" ] || [ $arg = "--num-gpus" ] || [ $arg = "--resume" ] || [ $arg = "--segmentation" ] || [ $arg = "--bbox-from-mask" ]
        then
            break #All scenes mounted
        else
            if [ -d $arg ]
            then
                scene_base=$(basename $arg)
                CMD="$CMD -v $arg:/home/user/workspace/data/$scene_base"
                DOCKER_ARGS="$DOCKER_ARGS /home/user/workspace/data/$scene_base"
            fi
        fi
    done

    #Grab flags
    i=0
    args=("$@")
    for arg in "$@"
    do
        if [ $arg = "--model" ]
        then
            CMD="$CMD -v ${args[i+1]}:/home/user/workspace/detectron2-model "
            DOCKER_ARGS="$DOCKER_ARGS --model /home/user/workspace/detectron2-model"

        elif [ "${args[i]}" = "--num-gpus" ]
        then
            DOCKER_ARGS="$DOCKER_ARGS --num-gpus ${args[i+1]}"
        elif [ "${args[i]}" = "--resume" ]
        then
            DOCKER_ARGS="$DOCKER_ARGS --resume"
        elif [ "${args[i]}" = "--segmentation" ]
        then
            DOCKER_ARGS="$DOCKER_ARGS --segmentation"
        elif [ "${args[i]}" = "--bbox-from-mask" ]
        then
            DOCKER_ARGS="$DOCKER_ARGS --bbox-from-mask"
        fi
        i=$((i + 1))
    done

    if [ "$PULL_IMAGES" = true ] ; then
        docker pull strayrobots/detectron2:latest
    fi

    CMD="$CMD --gpus all -it ${CONTAINER_PREFIX}detectron2:latest $DOCKER_ARGS"
    eval $CMD
}

model-subcommand() {
    if [ $# -lt 2 ]
        then
            echo "Not enough arguments supplied"
            exit 1
    fi
    if [ "$2" = "generate" ]
    then
        ${BIN_DIR}stray-model-generate "${@:3}"
    elif [ "$2" = "bake" ]
    then
        log_event "model-bake:start"
        model-bake-command "${@:3}"
    elif [ "$2" = "evaluate" ]
    then
        ${BIN_DIR}stray-model-evaluate "${@:3}"
    else
        echo "Incorrect verb"
    fi
}

studio-integrate() {
    i=$((i + 1))
    args=("$@")
    for arg in "$@"
    do
        if [ "${args[i]}" = "--debug" ]
        then
            debug=1
        fi
        i=$((i + 1))
    done

    if [ "$PULL_IMAGES" = true ] ; then
        docker pull strayrobots/integrate:latest
    fi

    docker run -it -v $scene_dir:/home/user/data ${CONTAINER_PREFIX}integrate2:latest /home/user/data $@
}

studio-subcommand() {
    scene_dir="$(absolute_path $3)"
    check_data_dir $scene_dir

    if [ "$2" = "integrate" ]
    then
        shift
        log_event "studio-integrate:start"
        studio-integrate $scene_dir $@
        log_event "studio-integrate:end"
    elif [ "$2" = "open" ]
    then
        log_event "studio-open:start"
        studio $scene_dir
    elif [ "$2" = "preview" ]
    then
        log_event "studio-preview:start"
        stray-preview $scene_dir
    else
        echo "Verb $2 not supported by studio subcommand."
        exit 1
    fi
}

photogrammetry-subcommand() {
    shift
    scene_dir="$(absolute_path $2)"
    check_data_dir $scene_dir

    if [ "$PULL_IMAGES" = "true" ]; then
        docker pull strayrobots/photogrammetry:latest
    fi

    if [ "$1" = "run" ]
    then
        shift
        log_event "photogrammetry:start"
        nvidia-docker run -it -v $scene_dir:/home/user/data ${CONTAINER_PREFIX}photogrammetry:latest /home/user/data $@
        log_event "photogrammetry:end"
    fi
}

calibration-subcommand() {
    if [ "$2" = "run" ]
    then
        log_event "calibration-run:start"
        task=$3
        scene_dir="$(absolute_path $4)"
        shift 2
        i=0
        args=("$@")
        for arg in "$@"
        do
            if [ "${args[i]}" = "--target" ]
            then
                target_yaml=$(absolute_path ${args[i+1]})
            elif [ "${args[i]}" = "--imu" ]
            then
                imu_yaml=$(absolute_path ${args[i+1]})
            elif [ "${args[i]}" = "--camera" ]
            then
                camera_yaml=$(absolute_path ${args[i+1]})
            fi
            i=$((i + 1))
        done

        if [ "$PULL_IMAGES" = true ] ; then
            docker pull strayrobots/calibrate:latest
        fi

        if [ "$task" = "intrinsics" ]; then
            if [ "$target_yaml" = "" ] || [ "$scene_dir" = "" ]; then
                echo "Both scene and target needs to be provided."
                echo ""
                echo "Usage: stray calibration run intrinsics <calibration-scene> --target <target.yaml>"
                exit 1
            fi
            docker run -it -v $scene_dir:/home/user/data/ \
                -v $target_yaml:/home/user/workspace/target.yaml ${CONTAINER_PREFIX}calibrate:latest run $@
        elif [ "$task" = "hand_eye" ]; then
            shift 2
            xhost + 127.0.0.1
            nvidia-docker run -it -v $scene_dir:/home/user/data/ \
                -e DISPLAY=$DISPLAY -v /tmp/.X11-unix:/tmp/.X11-unix:rw \
                -v $target_yaml:/home/user/workspace/target.yaml ${CONTAINER_PREFIX}hand-eye:latest run $@
            xhost - 127.0.0.1
        elif [ "$task" = "imu_noise" ]; then
            docker run -v $scene_dir:/home/user/data/ -v $target_yaml:/home/user/workspace/target.yaml \
                -v $camera_yaml:/home/user/workspace/camera.yaml -it ${CONTAINER_PREFIX}calibrate:latest run $@
        elif [ "$task" = "camera_imu" ]; then
            docker run -v $scene_dir:/home/user/data/ -v $target_yaml:/home/user/workspace/target.yaml \
                -v $imu_yaml:/home/user/workspace/imu.yaml -v $camera_yaml:/home/user/workspace/camera.yaml -it ${CONTAINER_PREFIX}calibrate:latest run $@
        else
            echo "Unrecognized calibration task $task. Try intrinsics or camera_imu."
        fi
    elif [ "$2" = "generate" ]; then
        target_yaml=$(absolute_path $3)
        shift 2
        log_event "calibration-generate:start"
        if [ ! -f $target_yaml ]
        then
            echo "Target file $target_yaml does not exist."
            exit 1
        fi
        docker run -v `pwd`:/home/user/data/ \
            -v $target_yaml:/home/user/workspace/target.yaml ${CONTAINER_PREFIX}calibrate:latest generate
    elif [ "$2" = "scale" ]; then
        shift 2
        log_event "calibration-scale:start"
        ${BIN_DIR}straylib-scale-calibration $@
    else
        "Verb $2 not supported by calibration subcommand. Try run or generate."
        exit 1
    fi
}

dataset-subcommand() {
    if [ "$2" = "import" ]
    then
        shift 2
        log_event "dataset-import:start"
        ${BIN_DIR}straylib-dataset-import $@
        log_event "dataset-import:end"
    elif [ "$2" = "cut" ]
    then
        shift 2
        log_event "dataset-cut:start"
        ${BIN_DIR}straylib-dataset-cut $@
    elif [ "$2" = "show" ]
    then
        shift 2
        log_event "dataset-show:start"
        ${BIN_DIR}straylib-dataset-show $@
    elif [ "$2" = "bake" ]
    then
        shift 2
        log_event "dataset-bake:start"
        ${BIN_DIR}straylib-dataset-bake $@
    else
        echo "verb $2 not recognized by dataset command."
        exit 1
    fi
}

if [ "$1" = "--version" ] || [ "$1" = "-v" ]
then
    echo "Stray Robots CLI version $VERSION"
elif [ "$1" = "label" ]
then
    label-subcommand $@
elif [ "$1" = "model" ]
then
    model-subcommand $@
elif [ "$1" = "studio" ]
then
    studio-subcommand $@
elif [ "$1" = "photogrammetry" ]
then
    photogrammetry-subcommand $@
elif [ "$1" = "calibration" ]
then
    calibration-subcommand $@
elif [ "$1" = "dataset" ]
then
    dataset-subcommand $@
else
    echo "Can't recognize subcommand $1."
fi

