#!/bin/bash
set -e

function docker_run_with_display {
    xhost +local:root;
    docker run -e DISPLAY -e QT_X11_NO_MITSHM=1 -v /tmp/.X11-unix:/tmp/.X11-unix:rw $@
    xhost -local:root;
}

if [ "$1" = "label" ]
then
    if [ $# -lt 2 ]
        then
            echo "Not enough arguments supplied"
            exit 1
    fi

    if [ "$2" = "generate" ]
    then
        stray-label-generate "${@:3}"
    elif [ "$2" = "show" ]
    then
        stray-label-show "${@:3}"
    else
        echo "Incorrect verb"
    fi
elif [ "$1" = "model" ]
then
    if [ $# -lt 2 ]
        then
            echo "Not enough arguments supplied"
            exit 1
    fi
    if [ "$2" = "generate" ]
    then
        stray-model-generate "${@:3}"
    elif [ "$2" = "bake" ]
    then
        stray-model-bake "${@:3}"
    elif [ "$2" = "evaluate" ]
    then
        stray-model-evaluate "${@:3}"
    else
        echo "Incorrect verb"
    fi

elif [ "$1" = "studio" ]
then
    if [ $# != 3 ]
    then
        echo "Usage: stray studio open/integrate <path-to-scene>"
        exit 1
    fi

    scene_dir=$3
    if [ ! -d "$scene_dir" ]; then
        echo "data directory does not exist: $scene_dir"
        exit 1
    fi

    if [ "$2" = "integrate" ]
    then
        docker run -it -v $scene_dir:/root/data orbslam
    elif [ "$2" = "open" ]
    then
        studio $scene_dir
    else
        echo "Verb $2 not supported by studio subcommand."
        exit 1
    fi
elif [ "$1" = "calibration" ]
then
    if [ "$2" = "run" ]
    then
        #TODO: input and parse these as flags and not positional arguments.
        scene_dir=$3
        target_yaml=$4
        docker_run_with_display -it -v $scene_dir:/root/data/ \
            -v $target_yaml:/root/workspace/target.yaml calibrate run
    elif [ "$2" = "generate" ]
    then
        target_yaml=$3
        shift 2
        docker run -v `pwd`:/root/data/ \
            -v $target_yaml:/root/workspace/target.yaml calibrate generate
    elif [ "$2" = "scale" ]
    then
        shift 2
        straylib-scale-calibration $@
    else
        "Verb $2 not supported by calibration subcommand. Try run or generate."
        exit 1
    fi
elif [ "$1" = "dataset" ]
then
    if [ "$2" = "import" ]
    then
        shift 2
        straylib-import $@
    fi
else
    echo "No command supplied"
fi

