name: Deploy Conda Environment

on:
  push:
    branches: [ main ]
    paths:
      - 'ops/package/*'
jobs:
  deploy:
    name: Build and push
    runs-on: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v2
      - uses: conda-incubator/setup-miniconda@v2
        with:
          python-version: 3.8

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y s3cmd

      - name: Create s3cmd config
        run: |
          echo "[default]" >> $HOME/.s3cfg
          echo "access_key = ${{ secrets.SPACES_ACCESS_KEY }}" >> $HOME/.s3cfg
          echo "host_base = ams3.digitaloceanspaces.com" >> $HOME/.s3cfg
          echo "host_bucket = %(bucket)s.ams3.digitaloceanspaces.com" >> $HOME/.s3cfg
          echo "secret_key = ${{ secrets.SPACES_SECRET_KEY }}" >> $HOME/.s3cfg

      - name: Create env and install constructor
        run: |
          conda create -n env Python=3.8 constructor

      - name: Build env and upload
        run: |
          pushd "ops/package"
          conda activate env
          constructor .

          arch="$(uname -m)"
          platform="$(uname | tr '[:upper:]' '[:lower:]')"
          destination="s3://stray-builds/cli/$platform/$arch/latest/install_env.sh"
          s3cmd put "install_env.sh" "$destination"
          s3cmd setacl "$destination" --acl-public
          popd






